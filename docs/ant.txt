export default {
  async fetch(request, env, ctx) {
    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': '*',
    };

    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: corsHeaders });
    }

    const url = new URL(request.url);
    const path = url.pathname;

    // 路由映射表（按长度排序，避免冲突）
    const routeMap = {
      '/autopush': 'autopush-cloudcode-pa.sandbox.googleapis.com',
      '/oauth2': 'oauth2.googleapis.com',
      '/daily': 'daily-cloudcode-pa.sandbox.googleapis.com'
    };

    // 按路径长度排序（长的优先匹配）
    const sortedRoutes = Object.entries(routeMap)
      .sort((a, b) => b[0].length - a[0].length);

    let targetHost = '';
    let matchedPrefix = '';

    for (const [prefix, host] of sortedRoutes) {
      if (path.startsWith(prefix)) {
        targetHost = host;
        matchedPrefix = prefix;
        break;
      }
    }

    if (!targetHost) {
      return new Response(JSON.stringify({
        status: "Worker is active. Route not found.",
        tips: "Please use /daily/..., /autopush/... or /oauth2/...",
        path: path
      }), {
        status: 404,
        headers: { ...corsHeaders, 'content-type': 'application/json' }
      });
    }

    // 重写 URL（使用 substring 更安全）
    url.hostname = targetHost;
    url.pathname = path.substring(matchedPrefix.length);

    // 清洗请求头
    const newHeaders = new Headers(request.headers);
    newHeaders.delete('Host');
    newHeaders.delete('cf-connecting-ip');
    newHeaders.delete('cf-ipcountry');
    newHeaders.delete('cf-ray');
    newHeaders.delete('cf-visitor');
    newHeaders.delete('x-forwarded-proto');
    newHeaders.delete('x-real-ip');
    newHeaders.delete('Origin');
    newHeaders.delete('Referer');

    // 构造新请求（GET/HEAD 不传 body）
    const requestOptions = {
      method: request.method,
      headers: newHeaders,
      redirect: 'follow'
    };

    if (request.method !== 'GET' && request.method !== 'HEAD') {
      requestOptions.body = request.body;
    }

    const newRequest = new Request(url.toString(), requestOptions);

    try {
      const response = await fetch(newRequest);

      const newResponse = new Response(response.body, response);
      newResponse.headers.set('Access-Control-Allow-Origin', '*');

      return newResponse;
    } catch (e) {
      // 改进错误信息
      return new Response(JSON.stringify({
        error: e.message,
        target: targetHost,
        path: url.pathname
      }), {
        status: 500,
        headers: { ...corsHeaders, 'content-type': 'application/json' }
      });
    }
  }
};